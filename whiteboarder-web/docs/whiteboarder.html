<!DOCTYPE html>

<html>
<head>
  <title>whiteboarder.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>whiteboarder.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">const</span> routePrefix = <span class="hljs-string">"/whiteboarder"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>State contains all the mutable variables of the program.
No state variables are allowed to be declared outside of this singleton.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> state = {
    <span class="hljs-attr">refreshIteration</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">sessionID</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">username</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">users</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">messages</span>: []
};</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p><code>callback</code> will be called with one parameter: the new sessionID.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">POST_Session</span>(<span class="hljs-params">callback</span>) </span>{
    $.ajax(routePrefix + <span class="hljs-string">'/session'</span>, {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"POST"</span>,
        <span class="hljs-attr">contentType</span>: <span class="hljs-string">"application/json"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">'text'</span>,
        <span class="hljs-attr">success</span>: callback,
        <span class="hljs-attr">timeout</span>: <span class="hljs-number">2000</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">msg</span>) </span>{
            <span class="hljs-built_in">console</span>.log(msg);
            alert(<span class="hljs-string">"error creating session: "</span> + msg.statusText);
        }
    });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Redirect the current browser page to the page for the given sessionID. Note
that if the sessionID is equivalent to the current sessionID, the page will
<strong>not</strong> be refreshed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">navigateToURLForSession</span>(<span class="hljs-params">sessionID</span>) </span>{
    <span class="hljs-keyword">var</span> parsedURL = <span class="hljs-keyword">new</span> URL(<span class="hljs-built_in">window</span>.location.href);
    <span class="hljs-keyword">var</span> currentURLSessionID = parsedURL.searchParams.get(<span class="hljs-string">"sessionID"</span>);
    <span class="hljs-keyword">if</span> (currentURLSessionID != sessionID) {
        <span class="hljs-keyword">if</span> (sessionID) {
            parsedURL.searchParams.set(<span class="hljs-string">"sessionID"</span>, sessionID);
        } <span class="hljs-keyword">else</span> {
            parsedURL.searchParams.delete(<span class="hljs-string">"sessionID"</span>);
        }
        <span class="hljs-built_in">console</span>.log(parsedURL.searchParams.get(<span class="hljs-string">"sessionID"</span>));
        <span class="hljs-built_in">console</span>.log(parsedURL.href);
        <span class="hljs-built_in">window</span>.location.href = parsedURL.href;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"udapted href"</span>);
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSessionIDFromURL</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> parsedURL = <span class="hljs-keyword">new</span> URL(<span class="hljs-built_in">window</span>.location.href);
    <span class="hljs-keyword">var</span> query = parsedURL.searchParams.get(<span class="hljs-string">"sessionID"</span>);
    <span class="hljs-built_in">console</span>.log(query);
    <span class="hljs-keyword">if</span> (query) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"parsed sessionID from url: "</span> + query);
        <span class="hljs-keyword">return</span> query;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshCurrentImage</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> sessionID = state.sessionID;
    <span class="hljs-keyword">if</span> (!sessionID) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> imgURL = routePrefix + <span class="hljs-string">'/image/'</span> + sessionID + <span class="hljs-string">'#q='</span> + ++state.refreshIteration;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'reloading image from '</span> + imgURL);
    <span class="hljs-keyword">var</span> img = $(<span class="hljs-string">'&lt;img /&gt;'</span>).attr({
        <span class="hljs-string">'src'</span>: imgURL,
        <span class="hljs-string">'id'</span>: <span class="hljs-string">'image'</span>
    });
    img.ready(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> oldCanvas = $(<span class="hljs-string">'#canvas'</span>);
        $(<span class="hljs-string">'#imagebox'</span>).empty().append(img);
        $(<span class="hljs-string">'#imagebox'</span>).append(oldCanvas);
    });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshUsersList</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!state.sessionID) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> usersURL = routePrefix + <span class="hljs-string">'/users/'</span> + state.sessionID + <span class="hljs-string">'#q='</span> + ++state.refreshIteration;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'reloading users from '</span> + usersURL);

    <span class="hljs-keyword">var</span> redrawUsers = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        $(<span class="hljs-string">'#joined-members'</span>).empty();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; state.users.length; i++) {
            <span class="hljs-keyword">var</span> user = state.users[i];
            $(<span class="hljs-string">"#joined-members"</span>).append(
                $(<span class="hljs-string">"&lt;li /&gt;"</span>).addClass(<span class="hljs-string">"list-group-item"</span>).addClass(<span class="hljs-string">"list-group-item-success"</span>).text(user[<span class="hljs-string">'username'</span>])
            );
        }
    }

    $.getJSON(usersURL, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
        state.users = data;
        redrawUsers();
    });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshMessagesList</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!state.sessionID) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (state.messages.length &gt; <span class="hljs-number">50</span>) state.messages = state.messages.slice(state.messages.length - <span class="hljs-number">50</span>);

    $(<span class="hljs-string">'#messagebox'</span>).empty();
    $(<span class="hljs-string">"#message-input"</span>).empty();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; state.messages.length; i++) {
        <span class="hljs-keyword">var</span> currentMsg = state.messages[i];
        <span class="hljs-keyword">var</span> currentAuth = currentMsg.username;
        <span class="hljs-keyword">var</span> currentMsgTime = currentMsg.timestamp;
        <span class="hljs-keyword">var</span> messageElement = $(<span class="hljs-string">"&lt;li /&gt;"</span>).addClass(<span class="hljs-string">"list-group-item"</span>);       
        $(<span class="hljs-string">"#messagebox"</span>).append(
            (currentAuth == state.username) ? messageElement.addClass(<span class="hljs-string">"list-group-item-success"</span>) : messageElement
        );
        messageElement.append(
            $(<span class="hljs-string">"&lt;p /&gt;"</span>).text(currentMsg.msg)
        );
        <span class="hljs-keyword">var</span> messageStamps = $(messageElement).append($(<span class="hljs-string">"&lt;div /&gt;"</span>).addClass(<span class="hljs-string">"msgmeta"</span>));
        messageStamps.append(
            $(<span class="hljs-string">"&lt;span /&gt;"</span>).addClass(<span class="hljs-string">"namestamp"</span>).text(currentAuth)
        );
        messageStamps.append(
            $(<span class="hljs-string">"&lt;span /&gt;"</span>).addClass(<span class="hljs-string">"timestamp"</span>).text(currentMsgTime)
        );
    }
}

$(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    state.sessionID = getSessionIDFromURL();

    <span class="hljs-keyword">if</span> (state.sessionID) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>If we are connected to a session, show the connected section and hide
the welcome page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $(<span class="hljs-string">"#section-welcome"</span>).hide();
        $(<span class="hljs-string">"#section-connected"</span>).show();

        <span class="hljs-keyword">new</span> QRCode(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"qrcode"</span>), {
            <span class="hljs-attr">width</span>: <span class="hljs-number">140</span>,
            <span class="hljs-attr">height</span>: <span class="hljs-number">140</span>
        }).makeCode(state.sessionID);

        state.username = <span class="hljs-built_in">window</span>.prompt(<span class="hljs-string">"Enter a username"</span>, <span class="hljs-string">"Anonymous"</span>);
        <span class="hljs-built_in">console</span>.log(state.username);
        websocketApp.init();
        refreshCurrentImage();
        refreshUsersList();
    } <span class="hljs-keyword">else</span> {
        $(<span class="hljs-string">"#section-welcome"</span>).show();
        $(<span class="hljs-string">"#section-connected"</span>).hide();
        websocketApp.close();
    }

    <span class="hljs-comment">/**
     * All button triggers are set up here.
     */</span>
    $(<span class="hljs-string">"#navbar-title"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ navigateToURLForSession(<span class="hljs-literal">null</span>); });
    $(<span class="hljs-string">"#navbar-home-link"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ navigateToURLForSession(<span class="hljs-literal">null</span>); });
    $(<span class="hljs-string">"#session-id-button-navbar"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        navigateToURLForSession($(<span class="hljs-string">"#session-id-input-navbar"</span>).val());
    });
    $(<span class="hljs-string">"#session-id-button-welcome"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        navigateToURLForSession($(<span class="hljs-string">"#session-id-input-welcome"</span>).val());
    });
    $(<span class="hljs-string">"#create-new-session"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        $(<span class="hljs-string">"#create-new-session"</span>).prop(<span class="hljs-string">"disabled"</span>, <span class="hljs-literal">true</span>);
        $(<span class="hljs-string">"#create-new-session"</span>).text(<span class="hljs-string">"Creating..."</span>);
        POST_Session(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">newSessionID</span>) </span>{
            navigateToURLForSession(newSessionID);
        });
    });

    <span class="hljs-keyword">var</span> sendMessage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> msgStr = $(<span class="hljs-string">"#message-input"</span>).val();
        <span class="hljs-keyword">if</span> (msgStr == <span class="hljs-literal">null</span> || msgStr.trim().length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
        $(<span class="hljs-string">'#message-input'</span>).val(<span class="hljs-string">''</span>);

        <span class="hljs-keyword">var</span> m = {
            <span class="hljs-attr">wbID</span>: state.sessionID,
            <span class="hljs-attr">messageID</span>: <span class="hljs-number">-1</span>,
            <span class="hljs-attr">username</span>: state.username,
            <span class="hljs-attr">message</span>: $(<span class="hljs-string">"#message-input"</span>).val(),
            <span class="hljs-attr">msg</span>: msgStr.trim(),
            <span class="hljs-attr">timestamp</span>: <span class="hljs-literal">null</span>
        }
        websocketApp.handleMessage(m);
    }

    $(<span class="hljs-string">"#message-submit"</span>).click(sendMessage);
    $(<span class="hljs-string">'#message-input'</span>).on(<span class="hljs-string">'keypress'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
        <span class="hljs-keyword">if</span> (e.which == <span class="hljs-number">13</span>) {
            sendMessage();
        }
    });
});</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>drawingApp contains all the logic of the “drawing” capability in the
application, including the different colors and sizes of markers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> drawingApp = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> canvas,
        context,
        canvasWidth,
        canvasHeight,
        colorBlack = <span class="hljs-string">"#000000"</span>,
        colorBlue = <span class="hljs-string">"#0000ff"</span>,
        colorGreen = <span class="hljs-string">"#00c142"</span>,
        colorRed = <span class="hljs-string">"#ff0000"</span>,
        colorEraser = <span class="hljs-string">"rgba(0,0,0,1)"</span>,
        stashedColor = colorBlack,
        brushHuge = <span class="hljs-number">20</span>,
        brushLarge = <span class="hljs-number">10</span>,
        brushNormal = <span class="hljs-number">5</span>,
        brushSmall = <span class="hljs-number">2</span>,
        stashedBrush = brushNormal,
        cachedX = [],
        cachedY = [],
        cachedColor = [],
        cachedSize = [],
        cachedDrag = [],
        edits = [],
        paint = <span class="hljs-literal">false</span>,
        currentColor = colorBlack,
        currentSize = brushNormal,
        currentTool = <span class="hljs-string">"marker"</span>,

        redraw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            context.clearRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.width, canvas.height);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Combine the edits from the server with any cached
“in progress” edits stored only on this client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> x = [], y = [], drag = [], color = [], size = [];
            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; edits.length; i++) {
                <span class="hljs-keyword">var</span> edit = edits[i];
                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; edit.points.length; j++) {
                    <span class="hljs-keyword">var</span> point = edit.points[j];
                    x.push(point.xcoord);
                    y.push(point.ycoord);
                    drag.push(j != <span class="hljs-number">0</span>);
                    size.push(edit.brushSize);

                    <span class="hljs-keyword">switch</span> (edit.color) {
                        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
                            color.push(colorBlack);
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                            color.push(colorBlue);
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                            color.push(colorGreen);
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
                            color.push(colorRed);
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">case</span> <span class="hljs-number">-1</span>:
                            color.push(colorEraser);
                            <span class="hljs-keyword">break</span>;
                    }
                }
            }
            x = x.concat(cachedX);
            y = y.concat(cachedY);
            drag = drag.concat(cachedDrag);
            color = color.concat(cachedColor);
            size = size.concat(cachedSize);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>This <code>for</code> loop takes care of the actual drawing on the canvas.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; x.length; i++) {
                context.beginPath();
                <span class="hljs-keyword">if</span> (drag[i] &amp;&amp; i &gt; <span class="hljs-number">0</span>) {
                    context.moveTo(x[i - <span class="hljs-number">1</span>], y[i - <span class="hljs-number">1</span>]);
                } <span class="hljs-keyword">else</span> {
                    context.moveTo(x[i] - <span class="hljs-number">1</span>, y[i]);
                }
                context.lineTo(x[i], y[i]);


                <span class="hljs-keyword">var</span> oldGlobalCompOp = context.globalCompositeOperation;
                <span class="hljs-keyword">if</span> (color[i] == colorEraser) { context.globalCompositeOperation = <span class="hljs-string">"destination-out"</span>; }

                context.strokeStyle = color[i];
                context.lineCap = <span class="hljs-string">"round"</span>;
                context.lineJoin = <span class="hljs-string">"round"</span>;
                context.lineWidth = size[i];

                context.stroke();
                context.globalCompositeOperation = oldGlobalCompOp;
            }
            context.closePath();
            context.restore();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Begin a new click.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        addClick = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, y, isDragging</span>) </span>{
            cachedX.push(x);
            cachedY.push(y);
            cachedColor.push(currentColor);
            cachedSize.push(currentSize);
            cachedDrag.push(isDragging);
        },

        addEdit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">edit</span>) </span>{
            <span class="hljs-keyword">if</span> (edit != <span class="hljs-literal">null</span>) {
                edits.push(edit);
                redraw();
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-keyword">var</span> colorNum, edit, points;

            colorNum = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">switch</span> (currentColor) {
                <span class="hljs-keyword">case</span> colorBlue:
                    colorNum = <span class="hljs-number">1</span>;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> colorGreen:
                    colorNum = <span class="hljs-number">2</span>;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> colorRed:
                    colorNum = <span class="hljs-number">3</span>;
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> colorEraser:
                    colorNum = <span class="hljs-number">-1</span>;
                    <span class="hljs-keyword">break</span>;
            }

            points = [];
            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; cachedX.length; i++)
                points.push({ <span class="hljs-attr">editID</span>: <span class="hljs-number">-1</span>, <span class="hljs-attr">xcoord</span>: cachedX[i], <span class="hljs-attr">ycoord</span>: cachedY[i] });

            edit = {
                <span class="hljs-attr">editID</span>: <span class="hljs-number">-1</span>,
                <span class="hljs-attr">wbID</span>: state.sessionID,
                <span class="hljs-attr">username</span>: state.username,
                <span class="hljs-attr">color</span>: colorNum,
                <span class="hljs-attr">brushSize</span>: currentSize,
                <span class="hljs-attr">points</span>: points,
                <span class="hljs-attr">timestamp</span>: <span class="hljs-literal">null</span>
            }

            websocketApp.handleEdit(edit, <span class="hljs-literal">false</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Clear the client-side cache of edits.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        resetEditCache = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            cachedX = [];
            cachedY = [];
            cachedColor = [];
            cachedSize = [];
            cachedDrag = [];
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Add triggers to the HTML elements to ensure we are notified when the
user performs an action. This includes the different marker colors
and sizing buttons.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setupListeners = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"marker"</span>).addEventListener(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (currentTool != <span class="hljs-string">"marker"</span>) {
                    currentColor = stashedColor;
                    currentSize = stashedBrush;
                    currentTool = <span class="hljs-string">"marker"</span>;
                }
            });
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"eraser"</span>).addEventListener(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (currentTool != <span class="hljs-string">"eraser"</span>) {
                    stashedColor = currentColor;
                    stashedBrush = currentSize;
                    currentColor = colorEraser;
                    currentSize = brushHuge;
                    currentTool = <span class="hljs-string">"eraser"</span>;
                }
            });
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"black"</span>).addEventListener(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                currentColor = colorBlack;
                stashedColor = colorBlack;
            });
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"blue"</span>).addEventListener(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                currentColor = colorBlue;
                stashedColor = colorBlue;
            });
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"green"</span>).addEventListener(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                currentColor = colorGreen;
                stashedColor = colorGreen;
            });
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"red"</span>).addEventListener(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                currentColor = colorRed;
                stashedColor = colorRed;
            });
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"huge"</span>).addEventListener(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (currentTool != <span class="hljs-string">"eraser"</span>) {
                    currentSize = brushHuge;
                    stashedBrush = brushHuge;
                }
            });
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"large"</span>).addEventListener(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (currentTool != <span class="hljs-string">"eraser"</span>) {
                    currentSize = brushLarge;
                    stashedBrush = brushLarge;
                }
            });
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"normal"</span>).addEventListener(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (currentTool != <span class="hljs-string">"eraser"</span>) {
                    currentSize = brushNormal;
                    stashedBrush = brushNormal;
                }
            });
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"small"</span>).addEventListener(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (currentTool != <span class="hljs-string">"eraser"</span>) {
                    currentSize = brushSmall;
                    stashedBrush = brushSmall;
                }
            });

            <span class="hljs-keyword">var</span> press = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
                <span class="hljs-keyword">var</span> offsetLeft = <span class="hljs-keyword">this</span>.offsetLeft + <span class="hljs-keyword">this</span>.parentElement.offsetLeft + <span class="hljs-keyword">this</span>.parentElement.parentElement.offsetLeft + <span class="hljs-keyword">this</span>.parentElement.parentElement.parentElement.offsetLeft,
                    offsetTop = <span class="hljs-keyword">this</span>.offsetTop + <span class="hljs-keyword">this</span>.parentElement.offsetTop + <span class="hljs-keyword">this</span>.parentElement.parentElement.offsetTop + <span class="hljs-keyword">this</span>.parentElement.parentElement.parentElement.offsetTop,
                    mouseX = e.pageX - offsetLeft,
                    mouseY = e.pageY - offsetTop;

                paint = <span class="hljs-literal">true</span>;
                resetEditCache();
                addClick(mouseX, mouseY, <span class="hljs-literal">false</span>);
                redraw();
            };
            <span class="hljs-keyword">var</span> drag = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
                <span class="hljs-keyword">var</span> offsetLeft = <span class="hljs-keyword">this</span>.offsetLeft + <span class="hljs-keyword">this</span>.parentElement.offsetLeft + <span class="hljs-keyword">this</span>.parentElement.parentElement.offsetLeft + <span class="hljs-keyword">this</span>.parentElement.parentElement.parentElement.offsetLeft,
                    offsetTop = <span class="hljs-keyword">this</span>.offsetTop + <span class="hljs-keyword">this</span>.parentElement.offsetTop + <span class="hljs-keyword">this</span>.parentElement.parentElement.offsetTop + <span class="hljs-keyword">this</span>.parentElement.parentElement.parentElement.offsetTop,
                    mouseX = e.pageX - offsetLeft,
                    mouseY = e.pageY - offsetTop;

                <span class="hljs-keyword">if</span> (paint) {
                    addClick(mouseX, mouseY, <span class="hljs-literal">true</span>);
                    redraw();
                }
            };
            <span class="hljs-keyword">var</span> release = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                paint = <span class="hljs-literal">false</span>;
                addEdit(<span class="hljs-literal">null</span>);
                redraw();
            };
            <span class="hljs-keyword">var</span> cancel = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                paint = <span class="hljs-literal">false</span>;
            };

            canvas.addEventListener(<span class="hljs-string">"mousedown"</span>, press, <span class="hljs-literal">false</span>);
            canvas.addEventListener(<span class="hljs-string">"mousemove"</span>, drag, <span class="hljs-literal">false</span>);
            canvas.addEventListener(<span class="hljs-string">"mouseup"</span>, release);
            canvas.addEventListener(<span class="hljs-string">"mouseout"</span>, cancel, <span class="hljs-literal">false</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Begin the program. Note that this function calls <code>setupListeners()</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        init = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            canvasWidth = $(<span class="hljs-string">'#imagebox'</span>).width();
            canvasHeight = $(<span class="hljs-string">'#imagebox'</span>).height();
            canvas = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'canvas'</span>);

            canvas.setAttribute(<span class="hljs-string">'width'</span>, canvasWidth);
            canvas.setAttribute(<span class="hljs-string">'height'</span>, canvasHeight);
            canvas.setAttribute(<span class="hljs-string">'id'</span>, <span class="hljs-string">'canvas'</span>);
            canvas.style.border = <span class="hljs-string">"2px dashed black"</span>;
            canvas.style.position = <span class="hljs-string">"absolute"</span>;

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> G_vmlCanvasManager !== <span class="hljs-string">"undefined"</span>) {
                canvas = G_vmlCanvasManager.initElement(canvas);
            }
            context = canvas.getContext(<span class="hljs-string">"2d"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Retrieve existing edits from the server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> editsURL = routePrefix + <span class="hljs-string">'/session/'</span> + state.sessionID + <span class="hljs-string">'#q='</span> + ++state.refreshIteration;
            $.getJSON(editsURL, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
                edits = data[<span class="hljs-string">'edits'</span>];
                redraw();
            });

            setupListeners();
        };

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">init</span>: init,
        <span class="hljs-attr">addEdit</span>: addEdit
    };
}());</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>The websocketApp encapsulates the entirety of the websocket logic, making it
easier to code the rest of the application over this abstraction.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> websocketApp = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> socket,
        url,

        handleEdit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">edit, isRemove</span>) </span>{
            <span class="hljs-keyword">if</span> (state.sessionID == <span class="hljs-literal">null</span> || state.username == <span class="hljs-literal">null</span>)
                <span class="hljs-keyword">return</span>;

            h = { <span class="hljs-attr">edit</span>: edit, <span class="hljs-attr">isRemove</span>: isRemove };
            socket.send(<span class="hljs-built_in">JSON</span>.stringify(h));
        },

        handleMessage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">message</span>) </span>{
            <span class="hljs-keyword">if</span> (state.sessionID == <span class="hljs-literal">null</span> || state.username == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;

            socket.send(<span class="hljs-string">"message:"</span> + <span class="hljs-built_in">JSON</span>.stringify(message));
        },

        setupEventHandlers = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            socket.onopen = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
                socket.send(<span class="hljs-string">"login:"</span> + state.sessionID + <span class="hljs-string">","</span> + state.username);
                drawingApp.init();
            };
            socket.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                alert(<span class="hljs-string">'WebSocket Error: '</span> + <span class="hljs-built_in">JSON</span>.stringify(error));
            };
            socket.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
                <span class="hljs-keyword">var</span> message = event.data;
                <span class="hljs-keyword">if</span> (message.startsWith(<span class="hljs-string">'refreshImage'</span>)) {
                    <span class="hljs-keyword">if</span> (message.substring(message.indexOf(<span class="hljs-string">':'</span>) + <span class="hljs-number">1</span>) == state.sessionID) { refreshCurrentImage(); }
                    <span class="hljs-keyword">return</span>;
                }

                <span class="hljs-keyword">if</span> (message.startsWith(<span class="hljs-string">'refreshUsers'</span>)) {
                    <span class="hljs-keyword">if</span> (message.substring(message.indexOf(<span class="hljs-string">':'</span>) + <span class="hljs-number">1</span>) == state.sessionID) { refreshUsersList(); }
                    <span class="hljs-keyword">return</span>;
                }

                <span class="hljs-keyword">if</span> (message.startsWith(<span class="hljs-string">'message'</span>)) {
                    <span class="hljs-keyword">var</span> msg = <span class="hljs-built_in">JSON</span>.parse(message.substring(<span class="hljs-number">8</span>));
                    <span class="hljs-keyword">if</span> (msg.wbID == state.sessionID) {
                        state.messages.push(msg);
                        refreshMessagesList();
                    }
                    <span class="hljs-keyword">return</span>;
                }

                <span class="hljs-keyword">var</span> h = <span class="hljs-built_in">JSON</span>.parse(message);
                <span class="hljs-keyword">if</span> (h.edit.wbID == state.sessionID)
                    drawingApp.addEdit(h.edit);
            };
            socket.onclose = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>There’s not much we can do with an onclose event, so we
essentially wait for the user to refresh. This shouldn’t
occur unless there are serious connectivity issues.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            };
        },

        init = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            href = <span class="hljs-built_in">window</span>.location.href;
            url = href.replace(<span class="hljs-built_in">window</span>.location.protocol, <span class="hljs-string">'ws:'</span>).replace(href.substring(href.indexOf(<span class="hljs-string">'?'</span>)), <span class="hljs-string">'ws/session'</span>);
            socket = <span class="hljs-keyword">new</span> WebSocket(url);
            setupEventHandlers();
        },

        close = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (socket != <span class="hljs-literal">null</span>)
                socket.close();
        };

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">init</span>: init,
        <span class="hljs-attr">close</span>: close,
        <span class="hljs-attr">handleEdit</span>: handleEdit,
        <span class="hljs-attr">handleMessage</span>: handleMessage
    };
}());</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
